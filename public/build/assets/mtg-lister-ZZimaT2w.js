function f(o){const{set:l,num:d}=o;return`${l} ${d}`}function g(o){const{set:l,num:d}=o;return{set:l,num:d}}function h(o){return new Promise((l,d)=>{o.onsuccess=e=>{l(e.target.result)},o.onerror=e=>{console.error(e),d(e.target.error||e)}})}async function p(o,l,d){const e=await new Promise(r=>{const t=window.indexedDB.open(o,l);t.onsuccess=a=>{r(a.target.result)},t.onupgradeneeded=a=>{const s=a.target.result;s.onerror=n=>{var i;console.error((i=n.target.error)==null?void 0:i.message)},d(s)}});return e.onerror=r=>{var t;console.error((t=r.target.error)==null?void 0:t.message)},e}function y(){const o=p("mtg-lister",1,t=>{t.createObjectStore("cards",{keyPath:"setNum"}),t.createObjectStore("cardList",{autoIncrement:!0}).createIndex("listName","listName",{unique:!1}),t.createObjectStore("options",{keyPath:"name"})}),l={async save(t){await this.saveAll([t])},async saveAll(t){t.forEach(s=>{s.setNum=s.setNum||f(s),s.savedAt=Date.now()});const a=(await o).transaction(["cards"],"readwrite").objectStore("cards");for(let s=0;s<t.length;s++)try{await a.put(t[s])}catch(n){console.log("Error storing card to DB",{card:t[s],cards:t}),console.error(n)}},async get(t){try{return h((await o).transaction(["cards"]).objectStore("cards").get(f(t)))}catch{return null}},async getList(t){const a=Object.keys(t.map(c=>f(c)).reduce((c,u)=>(c[u]=null,c),{})),s=[],n=(await o).transaction(["cards"]).objectStore("cards");let i;for(let c=0;c<t.length;c++)try{i=await h(n.get(a[c])),i?s.push(i):console.log("card not found",a[c])}catch(u){console.log("Error retrieving card "+a[c]),console.error(u)}return s}};function d(t){var c;const{key:a=null,listName:s=null,search:n=null,foil:i=!1}=t;return{key:a||void 0,listName:s||void 0,search:n?{q:n.q,results:(c=n.results)==null?void 0:c.map(g)}:void 0,card:t.card?g(t.card):null,foil:i}}return{cards:l,lists:{async getLists(){return h((await o).transaction(["cardList"]).objectStore("cardList").index("listName").getAllKeys())},async getList(t=""){return h((await o).transaction(["cardList"]).objectStore("cardList").index("listName").getAll(t))},async addRow(t,a=""){t=d(t),t.listName=a;const s=(await o).transaction(["cardList"],"readwrite").objectStore("cardList");return t.key=await h(s.add(t)),await h(s.put(t,t.key)),t},async updateRow(t){t=d(t),await h((await o).transaction(["cardList"],"readwrite").objectStore("cardList").put(t,t.key))},async removeRow(t){await h((await o).transaction(["cardList"],"readwrite").objectStore("cardList").delete(t))},async clearList(t=""){const a=await o;return new Promise(s=>{const i=a.transaction(["cardList"],"readwrite").objectStore("cardList").index("listName");i.openCursor(IDBKeyRange.only(t)).onsuccess=c=>{const u=c.target.result;u?(u.delete(),u.continue()):s()}})}},options:{async get(t,a=null){const s=await h((await o).transaction(["options"]).objectStore("options").get(t));return(s==null?void 0:s.value)||a},async set(t,a){await h((await o).transaction(["options"],"readwrite").objectStore("options").put({name:t,value:a}))}}}}function C(){const o=y(),l=Alpine.reactive({}),d={get(s){return l[f(s)]||null},set(s){return o.cards.save(this.remember(s))},remember(s){return s&&(l[f(s)]=s),s},async recall(s){let n=this.get(s);return n||(n=await o.cards.get(s),n&&console.info("card recalled",n),this.remember(n))},async recallList(s){(await o.cards.getList(s.filter(i=>!this.get(i)))).forEach(i=>this.remember(i))}};async function e(){return o.lists.getLists()}function r(s){const{set:n,num:i}=s;return{set:n,num:i,get card(){return d.get(s)}}}function t(s){var n;return{...s,search:s.search?{q:s.search.q,results:(n=s.search.results)==null?void 0:n.map(r)}:void 0,card:s.card?r(s.card):null,error:null,get hasError(){return!!this.error}}}function a(s){return{rows:[],async add(n){const i=await o.lists.addRow(n,s),c=t(i),u=this.rows.push(c);return this.rows[u-1]},async remove(n){return this.rows.splice(this.rows.indexOf(n),1),this.removeRowRecord(n)},async removeRowRecord(n){return o.lists.removeRow(n.key)},async clear(){this.rows=[],await o.lists.clearList(s)},async update(n){return await o.lists.updateRow(n)},get byNew(){return this.rows.toReversed()},async populate(){const n=(await o.lists.getList(s)).map(c=>t(c));this.rows.push(...n);const i={};n.forEach(c=>{var u;c.card?i[f(c.card)]=c.card:(u=c.search)!=null&&u.results&&c.search.results.forEach(m=>{i[f(m)]=c.card})}),await d.recallList(Object.values(i))}}}return{cards:d,cardPop:r,getLists:e,list:a}}document.addEventListener("alpine:init",()=>{const o=()=>(e=>e[Math.floor(Math.random()*e.length)])(["eld 299","fdn 128","snc 425","woe 287","ncc 13"]),l=C(),d=kat.rateLimitedService("https://api.scryfall.com/",100);Alpine.data("mtgLister",()=>({search:"",cardData:l.cards,isFoil:!1,list:l.list(""),lists:[],placeholder:o(),preview:null,select:null,hasSetsData:!!mtgSets.length,rowActionIndex:0,setCodeLock:null,async init(){this.lists=await l.getLists(),await this.list.populate()},get actionRow(){return this.list.byNew[this.rowActionIndex]||null},get actionRowKey(){var e;return(e=this.actionRow)==null?void 0:e.key},get setCodeHint(){var e;if(this.action.usePrev){if(this.action.do==="+")return this.action.match.card.set.toUpperCase();if(this.action.do==="l+")return this.action.setCode.toUpperCase()}return(e=this.setCodeLock)==null?void 0:e.toUpperCase()},setByCode(e){if(this.hasSetsData)try{return mtgSets.find(r=>r.code===e.toLowerCase())||null}catch(r){return console.error(e,r),null}return null},get lockedSetPlaceholder(){return this.setCodeLock?String(Math.floor(Math.random()*this.lockedSet.card_count)+1):this.placeholder},get lockedSet(){return this.setCodeLock?this.setByCode(this.setCodeLock):null},setName(e){const r=this.setByCode(e);return r?r.name:e.toUpperCase()},get resolvedCards(){return this.list.rows.filter(r=>{var t;return(t=r.card)==null?void 0:t.card})},get distinctCards(){const e=this.resolvedCards,r={},t=[];return e.forEach(a=>{const s=`${a.card.set}:${a.card.num}:${a.foil?"foil":"-"}`;r[s]!==void 0?t[r[s]].count++:(r[s]=t.length,t.push({count:1,name:a.card.card.name,set:a.card.set,num:a.card.num,foil:a.foil}))}),t},get csvDownload(){return encodeURI(`data:text/csv;charset=utf-8,Count,Name,Edition,Collector Number,Foil\r
`+this.distinctCards.map(e=>[e.count,`"${e.name.replace('"','""')}"`,e.set,e.num,e.foil?"foil":""].join(",")).join(`\r
`))},get csvFileName(){const e=this.resolvedCards.length;if(!e)return"mtg-list_empty.csv";const r=this.distinctCards[0].name.replace(/[^a-z0-9]/gi,"_").toLowerCase();return`mtg-list_${e}_${r}.csv`},matchCardRef(e){var i,c;if(!this.hasSetsData)return null;const r=e.split(" ");if(r.length===1&&this.setCodeLock&&r.unshift(this.setCodeLock),r.length!==2)return null;const t=r[0]==="<";if(t)if((i=this.actionRow)!=null&&i.set)r[0]=this.actionRow.set;else return null;const a=this.setByCode(r[0]==="<"&&((c=this.actionRow)!=null&&c.set)?this.actionRow.set:r[0]);if(!a)return null;const s=r[1].match(/(?<number>\d{1,4})(?<foil>f?)/i);if(!s)return null;const n=Number(s.groups.number);return n>a.card_count?null:{card:{set:a.code,num:n},foil:!!s.groups.foil,usePrev:t}},get action(){var s,n;const e=this.actionRow,r=(s=e==null?void 0:e.card)==null?void 0:s.card,t=this.search.trim().toLowerCase();if(!t)return r||(n=e==null?void 0:e.search)!=null&&n.results?{do:"++",row:e}:{do:null};if(t.length===1)switch(t){case"v":if(e)return{do:r?"vC":"vR",row:e};break;case"f":if(r)return{do:"f",row:e};break;case"<":if(this.setCodeLock)return{do:"l-"};if(r)return{do:"l+",setCode:r.set,usePrev:!0};break;case"x":if(e)return{do:"x",row:e};break;case"?":return{do:"?"}}if(t.slice(0,1)==="<"&&this.setByCode(t.slice(1)))return{do:"l+",setCode:t.slice(1)};const a=this.matchCardRef(t);if(a){const{card:i,foil:c,usePrev:u}=a;return{do:"+",match:{card:i,foil:c},usePrev:u}}return this.setCodeLock?{do:"s",search:`${t} set:${this.setCodeLock}`}:{do:"s",search:t}},get actionLabel(){switch(this.action.do){case null:case"s":return"Search Card";case"+":return"Add Card";case"++":return"Add Another";case"vC":return"View Card";case"vR":return"View Results";case"f":return"Toggle Foil";case"l+":return"Lock Set: "+this.action.setCode;case"l-":return"Unlock Set";case"x":return"Remove Row";case"?":return"Open Help"}},padCardNum(e){const r=this.setByCode(e.set),t=e.num+"";return r?t.padStart((r.card_count+"").length,"0"):t},mainAction(e){const r=this.action;switch(r.do){case null:return;case"+":this.fetchCard(r.match.card,r.match.foil).then();break;case"s":this.searchCard(r.search).then();break;case"++":this.addAnother(r.row).then();break;case"vC":e("view-card",r.row.card.card);break;case"vR":e("view-results",r.row);break;case"f":this.updateRow(r.row,{foil:!r.row.foil}).then();break;case"l+":this.setCodeLock=r.setCode;break;case"l-":this.setCodeLock=null;break;case"x":this.list.remove(r.row).then();break;case"?":e("open-help");break}this.resetInputs(),e("reset-set-search")},async fetchCard(e,r){const t=await this.list.add({card:e,foil:r});let a=t.card.card;a||(a=await l.cards.recall(t.card));const s=1e3*60*60*24*7;if(!a||a.savedAt<Date.now()-s)try{a=this.prepareScryfallCard(await this.scryfall(`cards/${e.set}/${e.num}`)),await l.cards.set(a)}catch(n){console.log("Error fetching and/or storing card",{ref:e,result:a||null,row:t}),t.error=n,console.error(n),await this.list.removeRowRecord(t)}},async searchCard(e){const r=await this.list.add({search:{q:e}}),t=new URLSearchParams;t.set("q",e),t.set("unique","prints"),t.set("order","released");try{let a=await this.scryfall(`cards/search?${t.toString()}`);a=await Promise.all(a.data.map(s=>(s=this.prepareScryfallCard(s),l.cards.set(s).then(()=>l.cardPop(s))))),a.length===1?await this.updateRow(r,{card:a[0]}):await this.updateRow(r,{results:a})}catch(a){r.error=a,console.error(r),await this.list.removeRowRecord(r)}},addAnother(e){const{search:r=null,card:t=null,foil:a}=e;return this.list.add({search:r,card:t,foil:a})},async updateRow(e,{card:r=null,results:t=null,foil:a=null}){r?(e.card=r,e.search=void 0):t&&(e.search.results=t),a!==null&&(e.foil=a),await this.list.update(e)},async removeRow(e){await this.list.remove(e)},async clearList(){window.confirm("Are you sure you want to remove all cards from the list?")&&await this.list.clear()},resetInputs(){this.search="",this.rowActionIndex=0,this.placeholder=o()},async scryfall(...e){const r=await d(...e);if(!r.ok)throw new Error(`Response status: ${r.status}`);return await r.json()},prepareScryfallCard(e){var m,w;const{name:r,set:t,collector_number:a,finishes:s,image_status:n,image_uris:i=null,card_faces:c=[]}=e,u=(i==null?void 0:i.png)||((w=(m=c[0])==null?void 0:m.image_uris)==null?void 0:w.png)||null;return{name:r,set:t,num:a,finishes:s,imageStatus:n,imageUri:u,fetchedAt:Date.now()}}}))});
